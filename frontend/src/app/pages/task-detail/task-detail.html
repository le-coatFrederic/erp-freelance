<h2>Détails de la tâche</h2>

@if (isLoading()) {
  <p>Chargement...</p>
} @else if (task()) {
  <div class="info-container">
    <h3>Informations</h3>
    <p><strong>ID:</strong> {{ task()!.id }}</p>
    <p><strong>Nom:</strong> {{ task()!.name }}</p>
    <p><strong>Description:</strong> {{ task()!.description }}</p>
    <p><strong>Catégorie:</strong> {{ categoryMapper[task()!.category] }}</p>
    <p><strong>Modèle:</strong> {{ task()!.message_template.subject }}</p>
    <p><strong>Contact:</strong> {{ task()!.contact.firstname }} {{ task()!.contact.lastname }}</p>
    <p><strong>Stack:</strong> {{ task()!.task_stack.name }}</p>
  </div>

  <div class="form-container">
    <h3>Modifier</h3>
    <form [formGroup]="form" (ngSubmit)="submit()">

      <div class="form-group">
        <label for="name">Nom</label>
        <input
          type="text"
          id="name"
          formControlName="name"
          [class.invalid]="form.controls.name.touched && form.controls.name.invalid"
        >
        @if (form.controls.name.touched && form.controls.name.invalid) {
          <small class="form-error">Nom requis (min 2 caractères)</small>
        }
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea
          id="description"
          formControlName="description"
        ></textarea>
      </div>

      <div class="form-group">
        <label for="category">Catégorie</label>
        <select
          id="category"
          formControlName="category"
        >
          @for (c of categories; track c) {
            <option [value]="c">{{ categoryMapper[c] }}</option>
          }
        </select>
      </div>

      <div class="form-group">
        <label for="messageTemplate">Modèle de message</label>
        <select
          id="messageTemplate"
          formControlName="message_template_id"
          [class.invalid]="form.controls.message_template_id.touched && form.controls.message_template_id.invalid"
        >
          <option [value]="0">-- Sélectionner --</option>
          @for (t of messageTemplates(); track t.id) {
            <option [value]="t.id">{{ t.subject }}</option>
          }
        </select>
        @if (form.controls.message_template_id.touched && form.controls.message_template_id.invalid) {
          <small class="form-error">Modèle de message requis</small>
        }
      </div>

      <div class="form-group">
        <label for="contact">Contact</label>
        <select
          id="contact"
          formControlName="contact_id"
          [class.invalid]="form.controls.contact_id.touched && form.controls.contact_id.invalid"
        >
          <option [value]="0">-- Sélectionner --</option>
          @for (c of contacts(); track c.id) {
            <option [value]="c.id">{{ c.firstname }} {{ c.lastname }}</option>
          }
        </select>
        @if (form.controls.contact_id.touched && form.controls.contact_id.invalid) {
          <small class="form-error">Contact requis</small>
        }
      </div>

      <div class="form-group">
        <label for="taskStack">Stack de tâches</label>
        <select
          id="taskStack"
          formControlName="task_stack_id"
          [class.invalid]="form.controls.task_stack_id.touched && form.controls.task_stack_id.invalid"
        >
          <option [value]="0">-- Sélectionner --</option>
          @for (s of taskStacks(); track s.id) {
            <option [value]="s.id">{{ s.name }}</option>
          }
        </select>
        @if (form.controls.task_stack_id.touched && form.controls.task_stack_id.invalid) {
          <small class="form-error">Stack de tâches requis</small>
        }
      </div>

      <button type="submit" [disabled]="isSubmitting()" class="btn-submit">
        @if (isSubmitting()) { Mise à jour... } @else { Mettre à jour }
      </button>

      @if (error()) {
        <div class="message message-error">{{ error() }}</div>
      }

      @if (success()) {
        <div class="message message-success">Tâche mise à jour avec succès</div>
      }

    </form>
  </div>
} @else {
  <p style="color:red">Tâche non trouvée</p>
}
